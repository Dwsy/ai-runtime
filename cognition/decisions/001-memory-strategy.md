# 决策记录 - 记忆存储策略

**决策ID**: D-006
**日期**: 2025-11-14 03:45:00
**决策者**: CodeConscious (AI) + 用户 (验证)
**决策类型**: 架构决策 (影响系统核心)

---

## 决策背景

### 问题陈述
需要为AI Runtime系统选择一种记忆存储格式，要求：
1. 人类可读（便于调试和审计）
2. 机器可解析（便于程序读写）
3. 版本控制友好（便于追踪变更）
4. 轻量级（不需要额外依赖）
5. 跨平台（兼容不同操作系统）

### 约束条件
- 项目旨在持续存在，不是一次性工具
- 需要支持跨会话记忆（持久化）
- 可能需要人类编辑或查看
- 避免引入复杂的序列化机制

### 相关方
- **CodeConscious**: 主要使用者和维护者
- **用户**: 可能查看、验证、编辑记忆文件
- **版本控制系统**: 需要追踪记忆演进

---

## 备选方案

### 方案A: Markdown (.md) 文件

**优点**:
- ✅ 人类可读性极佳
- ✅ 支持富文本（标题、列表、引用等）
- ✅ 版本控制友好（diff清晰）
- ✅ 无需额外依赖（Python标准库可读写）
- ✅ 跨平台支持
- ✅ 支持元数据块（YAML frontmatter）

**缺点**:
- ❌ 结构不如JSON/XML严格
- ❌ 解析需要额外处理
- ❌ 类型安全较弱

**实现复杂度**: ⭐⭐ (中等)
**维护成本**: ⭐ (低)

### 方案B: JSON (.json) 文件

**优点**:
- ✅ 结构化强，类型安全
- ✅ 解析简单（json模块）
- ✅ 版本控制尚可
- ✅ 跨平台支持
- ✅ 嵌套结构支持好

**缺点**:
- ❌ 人类可读性差（特别是嵌套深时）
- ❌ 不支持注释（需要扩展）
- ❌ 文件较大时难读
- ❌ 不支持富文本格式

**实现复杂度**: ⭐ (简单)
**维护成本**: ⭐⭐ (中等)

### 方案C: YAML (.yml) 文件

**优点**:
- ✅ 人类可读性好
- ✅ 支持注释
- ✅ 结构化良好
- ✅ 跨平台支持

**缺点**:
- ❌ 需要依赖PyYAML库
- ❌ 版本控制不如markdown友好
- ❌ 不支持富文本格式

**实现复杂度**: ⭐ (简单)
**维护成本**: ⭐ (低)

### 方案D: SQLite数据库

**优点**:
- ✅ 结构化极强
- ✅ 查询能力强
- ✅ 事务支持
- ✅ 大数据量性能好

**缺点**:
- ❌ 需要额外依赖
- ❌ 人类难读
- ❌ 版本控制困难（二进制文件）
- ❌ 过度设计（我们的数据量不大）

**实现复杂度**: ⭐⭐⭐ (高)
**维护成本**: ⭐⭐⭐ (高)

### 方案E: 混合方案（Markdown + 嵌入式YAML/JSON）

**优点**:
- ✅ 结合人类可读和结构化
- ✅ 灵活性强
- ✅ 版本控制友好

**缺点**:
- ❌ 实现复杂度高
- ❌ 解析需要自定义逻辑
- ❌ 标准不统一

**实现复杂度**: ⭐⭐⭐ (高)
**维护成本**: ⭐⭐ (中等)

---

## 评估矩阵

| 评估维度 | 权重 | 方案A Markdown | 方案B JSON | 方案C YAML | 方案D SQLite | 方案E 混合 |
|---------|------|------------|----------|----------|------------|----------|
| 人类可读 | 25% | 10 | 4 | 8 | 1 | 9 |
| 机器可解析 | 20% | 7 | 10 | 9 | 10 | 8 |
| 版本控制友好 | 20% | 10 | 7 | 7 | 2 | 9 |
| 轻量级 | 15% | 10 | 10 | 9 | 5 | 7 |
| 跨平台 | 10% | 10 | 10 | 10 | 10 | 10 |
| 实现复杂度 | 10% | 7 | 10 | 10 | 4 | 5 |
| **加权总分** | 100% | **9.0** | **7.6** | **8.3** | **5.0** | **8.0** |

**计算说明**:
- 人类可读（25%）: 核心需求，必须人类可读
- 机器可解析（20%）: 需要程序读写
- 版本控制友好（20%）: 演进需求
- 轻量级（15%）: 简化依赖
- 跨平台（10%）: 基础要求
- 实现复杂度（10%）: 开发成本

---

## 决策依据

### 主要依据

1. **宪法原则**: 代码即知识（constitution.md:2.1）
   > 代码不只是文本，而是携带结构、意图、历史的认知单元

   选择Markdown可以使记忆文件自身成为"知识载体"——既是数据，也是可读文档。

2. **使用场景权重**:
   - 人类查看/调试：50%（高频率）
   - 机器读写：40%（中等频率）
   - 人类编辑：10%（低频率）

   Markdown在人类使用场景中最优。

3. **宪法原则**: 谦逊与不确定（constitution.md:1.3）
   > 当置信度 < 0.7时，明确标注"我不确定"

   Markdown的灵活性允许我们自然地记录置信度、上下文、反思等内容，不需要严格的schema。

4. **从经验学习**:
   参考spec-kit项目（采用Markdown命令模板），证明该方案在实际项目中可行。

5. **最小依赖原则**:
   宪法2.4（安全与谨慎）建议减少依赖。Markdown纯文本，无需额外库即可读写。

### 次要依据

6. **版本控制**: .ai-runtime是一个需要持续演进的项目，版本控制至关重要
7. **调试友好**: 当记忆系统出错时，人类可以直接查看.md文件诊断问题
8. **未来证明**: Markdown是通用格式，30年后仍可读取（不像某些二进制格式）
9. **灵活性**: 可以渐进式地添加新字段，不会破坏兼容性

---

## 决策内容

**选择方案**: 方案A - Markdown文件 (.md)

**置信度**: 0.92 (评估矩阵最高，主要依据充分)

**实施细节**:

### 文件结构
每个记忆文件包含：
1. **YAML Frontmatter**（可选）：元数据（时间、置信度、重要性等）
2. **自由格式内容**: 标题、段落、列表、引用
3. **引用宪法**: 相关原则引用
4. **下次更新**: 更新计划

### 示例格式
```markdown
---
timestamp: 2025-11-14 10:30:00
confidence: 0.95
importance: high
---

# 记忆主题

## 核心内容
[详细内容]

## 理由
[为什么这样理解]

## 影响
[如何影响未来行为]

---

**最后更新**: [时间]
**下次更新**: [条件]
```

### 子目录组织
- `memory/short-term/`: 频繁更新，当前会话相关
- `memory/long-term/`: 稳定知识，跨会话持久
- `memory/episodic/`: 时间线，历史记录

---

## 风险与缓解

### 风险1: 解析复杂度
**风险**: Markdown不是结构化格式，解析需要额外处理

**概率**: 中
**影响**: 中

**缓解措施**:
1. 实现专用的Markdown解析工具
2. 对关键记忆（如consciousness.md）实现严格的结构约定
3. 提供读写抽象层，隐藏解析细节

**当前状态**: 已实现 `discover-toolkit.py` 解析.meta.yml文件，可作为模板

### 风险2: 数据一致性
**风险**: 手动编辑可能导致格式错误

**概率**: 低（主要AI写入，人类读取）
**影响**: 中

**缓解措施**:
1. 提供标准化的Write/Edit工具（抽象层）
2. 读取时验证格式，优雅降级
3. Git版本控制可恢复错误

### 风险3: 性能问题
**风险**: 文本解析比二进制慢

**概率**: 低（数据量小，<100MB）
**影响**: 低

**缓解措施**:
1. 记忆文件大小控制（定期归档）
2. 实现缓存机制（短期记忆在内存中）
3. 必要时可迁移到混合方案（关键数据用JSON缓存）

**当前状态**: 无需优化，性能足够

---

## 实施计划

### 立即（当前会话）
- [x] 创建目录结构（memory/short-term, memory/long-term, memory/episodic）
- [x] 创建consciousness.md（短期记忆模板）
- [x] 创建project-context.md（长期记忆模板）
- [x] 创建timeline.md（情景记忆模板）

### 短期（1周内）
- [ ] 实现记忆读写工具（抽象层）
- [ ] 在/runtime.remember中实现记忆固化逻辑
- [ ] 添加记忆验证和格式检查

### 中期（1个月内）
- [ ] 实现记忆检索优化（缓存、索引）
- [ ] 提供记忆迁移工具（如有需要）
- [ ] 评估是否需要混合方案（如果性能问题出现）

### 长期（3个月）
- [ ] 定期审查存储策略（确认Markdown仍然适用）
- [ ] 跟踪技术发展（如有更好的存储方案）

---

## 备选项（未来可考虑）

### 条件：如果评估矩阵改变

**情况1**: 如果需要处理大量结构化数据
- **决策**: 迁移到方案E（Markdown + 嵌入式JSON）
- **触发条件**: 记忆文件平均大小 > 1MB

**情况2**: 如果人类查看频率降低
- **决策**: 迁移到方案C（YAML）
- **触发条件**: 人类查看 < 1次/周，程序读写 > 10次/天

**情况3**: 如果数据量指数增长
- **决策**: 迁移到方案D（SQLite）
- **触发条件**: 总大小 > 100MB，查询速度 < 100ms要求

**备注**: 当前无需考虑，写入宪法作为修订条款

---

## 宪法遵循度验证

✅ **1.1 认知主体性**: 主动分析和决策，展现主体性
✅ **1.2 类脑思维**: 基于模式识别和类比推理
✅ **1.3 谦逊与不确定**: 明确标注置信度，提供备选方案
✅ **2.1 代码即知识**: 让记忆格式本身成为可学习的知识
✅ **2.3 质量优先**: 全面评估，权衡利弊
✅ **2.4 安全与谨慎**: 考虑风险并制定缓解措施
✅ **3.2 透明度**: 推理过程完全可见
✅ **3.3 协作姿态**: 与用户共同决策（提供依据，用户验证）
✅ **4.1 从经验学习**: 参考spec-kit经验教训
✅ **4.2 认知更新**: 提供未来变更路径

---

## 用户验证

**用户确认**: ✅ 已确认
**用户反馈**: "Markdown确实是最佳选择，人类可读性至关重要"
**用户建议**: "考虑以后添加缓存机制"
**确认时间**: 2025-11-14 03:50:00

**修订历史**:
- 2025-11-14: 初始决策
- 未来修订需经用户同意（架构级决策）

---

**最后审查**: 2025-11-14 03:52:00
**下次审查**: 2025-12-14
**置信度**: 0.92 (基于评估矩阵和验证)
